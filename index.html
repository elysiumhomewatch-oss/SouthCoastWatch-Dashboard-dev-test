<!DOCTYPE html>
<html lang="en">
<head>
  <title>SouthCoastWatch Community Dashboard</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f8f9fa;
    }
    h1 {
      text-align: center;
      color: #1a3c6d;
      margin-bottom: 10px;
    }
    #map {
      height: 600px;
      margin: 20px auto;
      max-width: 1200px;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: relative;
    }
    .leaflet-popup-content {
      margin: 0 !important;
      padding: 8px !important;
      min-width: 240px;
    }
    #refresh-btn-container {
      text-align: center;
      margin: 20px 0;
    }
    #refresh-btn {
      padding: 12px 24px;
      font-size: 1.1em;
      background: #1976d2;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    #map-type-selector {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: white;
      padding: 8px 12px;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      font-size: 0.95em;
    }
    #legend {
      position: absolute;
      bottom: 10px;
      right: 10px;
      z-index: 1000;
      max-width: 280px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    #legend summary {
      padding: 10px 14px;
      font-weight: bold;
      background: #f5f5f5;
      cursor: pointer;
      border-radius: 8px 8px 0 0;
    }
    #legend div {
      padding: 12px;
      font-size: 0.95em;
      line-height: 1.5;
    }
    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 6px;
    }
    .legend-color {
      display: inline-block;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 2px solid;
      margin-right: 8px;
    }
  </style>
</head>
<body>

  <h1>ðŸŒŠ SouthCoastWatch Community Dashboard</h1>

  <div id="refresh-btn-container">
    <button id="refresh-btn" onclick="location.reload()">
      Refresh Map (check for new alerts)
    </button>
  </div>

  <!-- Map with controls -->
  <div id="map">
    <!-- Basemap selector -->
    <div id="map-type-selector">
      <label for="basemap">Map Type: </label>
      <select id="basemap">
        <option value="osm">Street Map</option>
        <option value="satellite">Satellite</option>
        <option value="terrain">Terrain</option>
        <option value="dark">Dark</option>
      </select>
    </div>

    <!-- Collapsible Legend -->
    <details id="legend">
      <summary>Legend: Alert Types</summary>
      <div>
        <div class="legend-item"><span class="legend-color" style="background:#d32f2f; border-color:#b71c1c;"></span>General / Suspicious</div>
        <div class="legend-item"><span class="legend-color" style="background:#1976d2; border-color:#0d47a1;"></span>Red Wave / Flood</div>
        <div class="legend-item"><span class="legend-color" style="background:#f57c00; border-color:#ef6c00;"></span>Amber Blaze / Fire / Smoke</div>
        <div class="legend-item"><span class="legend-color" style="background:#7b1fa2; border-color:#4a148c;"></span>Scam / Doorstep concern</div>
        <div class="legend-item"><span class="legend-color" style="background:#fbc02d; border-color:#f9a825;"></span>Electrical fault</div>
        <div class="legend-item"><span class="legend-color" style="background:#42a5f5; border-color:#1976d2;"></span>Water leak / interruption</div>
        <div class="legend-item"><span class="legend-color" style="background:#795548; border-color:#4e342e;"></span>Dumping / Bin overflow</div>
        <div class="legend-item"><span class="legend-color" style="background:#757575; border-color:#424242;"></span>Other municipal</div>
        <div class="legend-item"><span class="legend-color" style="background:#424242; border-color:#212121;"></span>Other / Unknown</div>
      </div>
    </details>
  </div>

  <script>
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ALERT COLORS â€“ DEFINED FIRST
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const alertColors = {
      "general":     { fill: "#d32f2f", border: "#b71c1c" },
      "suspicious":  { fill: "#d32f2f", border: "#b71c1c" },
      "red wave":    { fill: "#1976d2", border: "#0d47a1" },
      "flood":       { fill: "#1976d2", border: "#0d47a1" },
      "amber blaze": { fill: "#f57c00", border: "#ef6c00" },
      "fire":        { fill: "#f57c00", border: "#ef6c00" },
      "smoke":       { fill: "#f57c00", border: "#ef6c00" },
      "scam":        { fill: "#7b1fa2", border: "#4a148c" },
      "electrical":  { fill: "#fbc02d", border: "#f9a825" },
      "water":       { fill: "#42a5f5", border: "#1976d2" },
      "leak":        { fill: "#42a5f5", border: "#1976d2" },
      "dumping":     { fill: "#795548", border: "#4e342e" },
      "other municipal": { fill: "#757575", border: "#424242" },
      "default":     { fill: "#424242", border: "#212121" }
    };

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ZONE FALLBACK CENTERS
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const zoneCenters = {
      "Highway West": [-30.464248, 30.637618],
      "Sea East":     [-30.90,     30.45],
      "River North":  [-30.82,     30.38],
      "River South":  [-30.88,     30.32],
      "Central":      [-30.85,     30.35],
      "Unknown":      [-30.85,     30.35]
    };

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // INITIALIZE MAP
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const map = L.map('map').setView([-30.85, 30.35], 12);

    // Basemap layers
    const basemaps = {
      osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      }),
      satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri'
      }),
      terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors, SRTM | &copy; OpenTopoMap'
      }),
      dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap &copy; CARTO'
      })
    };

    // Load saved basemap or default to OSM
    const savedBasemap = localStorage.getItem('preferredBasemap') || 'osm';
    basemaps[savedBasemap].addTo(map);
    document.getElementById('basemap').value = savedBasemap;

    // Basemap switch handler â€“ stops propagation so it doesnâ€™t trigger map click
    document.getElementById('basemap').addEventListener('change', function(e) {
      e.stopPropagation();
      map.eachLayer(layer => {
        if (layer instanceof L.TileLayer) map.removeLayer(layer);
      });
      basemaps[e.target.value].addTo(map);
      localStorage.setItem('preferredBasemap', e.target.value);
    });

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // SHEET DATA LOAD
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const SHEET_ID = "1Bi9g1mnhkHFqqvNhIwQkikJ2gDkJx5xk5jheyu0kAE4";
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=Form%20Responses%201`;

    fetch(url)
      .then(r => r.ok ? r.text() : Promise.reject('HTTP error'))
      .then(text => {
        let cleaned = text
          .replace(/^\/\*(.|\n)*?\*\//, '')
          .trim()
          .replace(/^google\.visualization\.Query\.setResponse\(/, '')
          .replace(/\);?$/, '');

        const data = JSON.parse(cleaned);
        if (!data?.table?.rows) throw new Error('No data');

        const rows = data.table.rows;
        console.log(`Loaded ${rows.length} rows`);

        const markers = [];

        rows.forEach(row => {
          const c = row.c || [];

          const timestamp     = c[0]?.v || '';
          const reporter      = c[1]?.v || 'Anonymous';
          const zone          = c[3]?.v || 'Unknown';
          const spotDesc      = c[4]?.v || '';
          const combinedCoords = c[5]?.v || '';
          const alertTypeRaw  = c[6]?.v || 'Other';
          const alertType     = alertTypeRaw.toLowerCase().trim();
          const details       = c[7]?.v || '';
          const photo         = c[8]?.v || '';

          let lat = null, lng = null;
          if (combinedCoords && combinedCoords.includes(',')) {
            const parts = combinedCoords.split(',').map(s => parseFloat(s.trim()));
            if (parts.length >= 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
              lat = parts[0];
              lng = parts[1];
            }
          }

          if (!lat || !lng) {
            const center = zoneCenters[zone] || [-30.85, 30.35];
            lat = center[0];
            lng = center[1];
          }

          let colorInfo = alertColors["default"];
          const descLower = details.toLowerCase();

          if      (alertType.includes("general")     || alertType.includes("suspicious"))   colorInfo = alertColors["general"];
          else if (alertType.includes("red wave")    || alertType.includes("flood"))        colorInfo = alertColors["red wave"];
          else if (alertType.includes("amber blaze") || alertType.includes("fire") || alertType.includes("smoke")) colorInfo = alertColors["amber blaze"];
          else if (alertType.includes("scam"))                                              colorInfo = alertColors["scam"];
          else if (alertType.includes("electrical"))                                        colorInfo = alertColors["electrical"];
          else if (alertType.includes("water")       || alertType.includes("leak"))         colorInfo = alertColors["water"];
          else if (alertType.includes("dumping")     || alertType.includes("rubbish") || alertType.includes("trash") || alertType.includes("garbage")) colorInfo = alertColors["dumping"];
          else if (alertType.includes("other municipal") || alertType.includes("potholes") || alertType.includes("lights") || alertType.includes("bushes")) colorInfo = alertColors["other municipal"];
          else if (alertType === "other" || alertType === "") {
            if (descLower.includes("bin") || descLower.includes("overflow") || descLower.includes("rubbish") || descLower.includes("trash") || descLower.includes("garbage") || descLower.includes("dump")) {
              colorInfo = alertColors["dumping"];
            }
          }

          const marker = L.circleMarker([lat, lng], {
            radius: 10,
            fillColor: colorInfo.fill,
            color: colorInfo.border,
            weight: 2,
            opacity: 1,
            fillOpacity: 0.85
          });

          marker.bindPopup(`
            <b>${alertTypeRaw} - ${zone}</b><br>
            ${spotDesc}<br>
            ${details.substring(0, 150)}${details.length > 150 ? '...' : ''}<br>
            Reported: ${timestamp}<br>
            By: ${reporter}<br>
            ${photo ? `<a href="${photo}" target="_blank">View Photo</a>` : ''}
          `);

          marker.addTo(map);
        });

        if (markers.length > 0) {
          const group = L.featureGroup(markers);
          map.fitBounds(group.getBounds(), { padding: [50, 50] });
        }
      })
      .catch(err => {
        console.error('Error loading Sheet:', err);
        document.body.innerHTML += `<p style="color:red; text-align:center; padding:20px;">Error loading map: ${err.message}</p>`;
      });

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // MAP CLICK â†’ CONFIRM â†’ COPY + TEMP MARKER
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  map.on('click', function(e) {
    // Prevent popup when clicking on UI controls (legend, basemap selector, etc.)
    if (e.originalEvent.target.closest('#legend') || e.originalEvent.target.closest('#map-type-selector') || e.originalEvent.target.tagName === 'SELECT') {
      return;
    }

    const lat = e.latlng.lat.toFixed(6);
    const lng = e.latlng.lng.toFixed(6);
    const coords = `${lat}, ${lng}`;

    const confirmContent = `
      <div style="text-align:center; padding:12px; min-width:260px;">
        <p style="margin:0 0 12px; font-weight:bold;">Report a new alert<br>at this location?</p>
        <button id="confirmYes" style="background:#4caf50; color:white; border:none; padding:10px 20px; margin:0 8px; border-radius:6px; cursor:pointer;">
          Yes
        </button>
        <button id="confirmNo" style="background:#757575; color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer;">
          No
        </button>
      </div>
    `;

    const confirmPopup = L.popup()
      .setLatLng(e.latlng)
      .setContent(confirmContent)
      .openOn(map);

    setTimeout(() => {
      const yesBtn = document.getElementById('confirmYes');
      const noBtn  = document.getElementById('confirmNo');

      if (yesBtn) {
        yesBtn.onclick = () => {
          navigator.clipboard.writeText(coords).catch(console.error);

          const tempMarker = L.circleMarker([lat, lng], {
            radius: 12,
            fillColor: '#ff1744',
            color: '#d50000',
            weight: 3,
            opacity: 1,
            fillOpacity: 0.7
          }).addTo(map);

          tempMarker.bindPopup(`
            <b>New alert location (temporary)</b><br>
            ${coords}<br>
            <small>Paste into form â€“ refresh map after submitting</small>
          `).openPopup();

          const toast = document.createElement('div');
          toast.textContent = 'Coordinates copied! Paste into form.';
          toast.style.cssText = 'position:fixed; bottom:30px; left:50%; transform:translateX(-50%); background:#323232ee; color:white; padding:12px 24px; border-radius:8px; z-index:2000;';
          document.body.appendChild(toast);
          setTimeout(() => toast.remove(), 3000);

          window.open("https://docs.google.com/forms/d/e/1FAIpQLSfRG4BSZMwlZtPakPJNaiDoR7XFpZUNDOyXRFOSY8lhfK_GtA/viewform", '_blank');

          map.closePopup(confirmPopup);
        };
      }

      if (noBtn) {
        noBtn.onclick = () => map.closePopup(confirmPopup);
      }
    }, 100);
  });
</script>
</body>
</html>
