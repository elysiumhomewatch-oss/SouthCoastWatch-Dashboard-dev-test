<!DOCTYPE html>
<html lang="en">
<head>
  <title>SouthCoastWatch Community Dashboard</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Extra basemap tiles (all free & attribution-compliant) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />

  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f8f9fa; }
    h1 { text-align: center; color: #1a3c6d; margin-bottom: 10px; }
    #map { height: 600px; margin: 20px auto; max-width: 1200px; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: relative; }
    #map-type-selector {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: white;
      padding: 8px 12px;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      font-size: 1em;
      border: 1px solid #ccc;
    }
    #map-type-selector select {
      padding: 6px;
      font-size: 1em;
      border-radius: 4px;
      border: 1px solid #999;
      background: #f9f9f9;
      cursor: pointer;
    }
    #refresh-btn-container {
      text-align: center;
      margin: 20px 0;
    }
    #refresh-btn {
      padding: 12px 24px;
      font-size: 1.1em;
      background: #1976d2;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>ðŸŒŠ SouthCoastWatch Community Dashboard</h1>

  <div style="text-align:center; margin: 20px 0;">
    <button onclick="location.reload()" style="padding:12px 24px; font-size:1.1em; background:#1976d2; color:white; border:none; border-radius:8px; cursor:pointer;">
      Refresh Map (check for new alerts)
    </button>
  </div>

  <!-- Collapsible Filters Panel -->
  <details id="filters" style="max-width: 800px; margin: 0 auto 20px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden;">
    <summary style="padding: 14px; font-weight: bold; background: #e3f2fd; cursor: pointer; font-size: 1.1em; border-radius: 8px;">
      Filters & Controls
    </summary>
    <div style="padding: 16px; display: flex; flex-direction: column; gap: 20px;">
      <!-- Alert Type Checkboxes -->
      <div>
        <strong>Show only these alert types:</strong>
        <div id="type-filters" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 8px; margin-top: 8px;">
          <!-- Checkboxes generated by script -->
        </div>
      </div>

      <!-- Time Slider -->
      <div>
        <strong>Show alerts from the last:</strong>
        <input type="range" id="time-slider" min="0" max="4" value="4" step="1" style="width: 100%; margin-top: 8px;">
        <div id="time-label" style="text-align: center; margin-top: 6px; font-weight: bold; color: #1976d2;">
          All time
        </div>
      </div>
    </div>
  </details>

  <!-- Map -->
  <div id="map" style="height: 600px; margin: 20px auto; max-width: 1200px; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: relative;"></div>

  <script>
    // === ZONE FALLBACK CENTERS ===
    const zoneCenters = {
      "Highway West": [-30.464248, 30.637618],
      "Sea East": [-30.90, 30.45],
      "River North": [-30.82, 30.38],
      "River South": [-30.88, 30.32],
      "Central": [-30.85, 30.35],
      "Unknown": [-30.85, 30.35]
    };

    // === COLOR & LABEL CONFIG FOR FILTERS & MARKERS ===
    const alertTypesConfig = [
      { key: "general", label: "General / Suspicious", fill: "#d32f2f", border: "#b71c1c" },
      { key: "red wave", label: "Red Wave / Flood", fill: "#1976d2", border: "#0d47a1" },
      { key: "amber blaze", label: "Amber Blaze / Fire / Smoke", fill: "#f57c00", border: "#ef6c00" },
      { key: "scam", label: "Scam / Doorstep concern", fill: "#7b1fa2", border: "#4a148c" },
      { key: "electrical", label: "Electrical fault", fill: "#fbc02d", border: "#f9a825" },
      { key: "water", label: "Water leak / interruption", fill: "#42a5f5", border: "#1976d2" },
      { key: "dumping", label: "Dumping / Bin overflow", fill: "#795548", border: "#4e342e" },
      { key: "other municipal", label: "Other municipal (potholes, lights, bushes)", fill: "#757575", border: "#424242" },
      { key: "other", label: "Other / Unknown", fill: "#424242", border: "#212121" }
    ];

    // === INITIALIZE MAP ===
    const map = L.map('map').setView([-30.85, 30.35], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // === SHEET ID & URL ===
    const SHEET_ID = "1Bi9g1mnhkHFqqvNhIwQkikJ2gDkJx5xk5jheyu0kAE4";
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=Form%20Responses%201`;

    // === GLOBAL FILTER STATE ===
    let allMarkers = []; // all markers for filtering
    let activeTypes = new Set(alertTypesConfig.map(t => t.key)); // default: all shown
    let timeFilterDays = Infinity; // default: all time

    // === TIME LABELS FOR SLIDER ===
    const timeLabels = ["Last 24 hours", "Last 3 days", "Last 7 days", "Last 30 days", "All time"];

    // === CREATE CHECKBOXES DYNAMICALLY ===
    const typeFiltersDiv = document.getElementById('type-filters');
    alertTypesConfig.forEach(type => {
      const label = document.createElement('label');
      label.style = 'display: flex; align-items: center; gap: 6px; cursor: pointer;';
      label.innerHTML = `
        <input type="checkbox" class="type-checkbox" value="${type.key}" checked>
        <span style="width:16px; height:16px; background:${type.fill}; border-radius:50%; border:2px solid ${type.border};"></span>
        ${type.label}
      `;
      typeFiltersDiv.appendChild(label);
    });

    // === RESTORE FILTER STATE FROM LOCALSTORAGE ===
    const savedTypes = localStorage.getItem('alertTypeFilters');
    if (savedTypes) {
      activeTypes = new Set(JSON.parse(savedTypes));
      document.querySelectorAll('.type-checkbox').forEach(cb => {
        cb.checked = activeTypes.has(cb.value);
      });
    }

    const savedTime = localStorage.getItem('timeFilterDays');
    if (savedTime !== null) {
      timeFilterDays = savedTime === 'Infinity' ? Infinity : parseInt(savedTime, 10);
      const sliderVal = timeFilterDays === Infinity ? 4 : [1,3,7,30].indexOf(timeFilterDays);
      document.getElementById('time-slider').value = sliderVal;
      document.getElementById('time-label').textContent = timeLabels[sliderVal];
    }

    // === APPLY FILTERS FUNCTION ===
    function applyFilters() {
      allMarkers.forEach(marker => {
        const type = marker.options.alertType || 'other';
        const ts = marker.options.timestamp || '';
        const rowTime = parseTimestamp(ts);
        const isTypeVisible = activeTypes.has(type) || activeTypes.size === 0;
        const isTimeVisible = timeFilterDays === Infinity || (rowTime && (Date.now() - rowTime) <= timeFilterDays * 24 * 60 * 60 * 1000);

        if (isTypeVisible && isTimeVisible) {
          if (!map.hasLayer(marker)) marker.addTo(map);
        } else {
          if (map.hasLayer(marker)) map.removeLayer(marker);
        }
      });
    }

    function parseTimestamp(ts) {
      if (!ts || !ts.startsWith('Date(')) return null;
      const match = ts.match(/Date\((\d+),(\d+),(\d+),(\d+),(\d+),(\d+)\)/);
      if (!match) return null;
      const [_, year, month, day, hour, min, sec] = match;
      return new Date(year, month, day, hour, min, sec).getTime();
    }

    // === TIME SLIDER CHANGE ===
    document.getElementById('time-slider').addEventListener('input', function(e) {
      const val = parseInt(e.target.value, 10);
      timeFilterDays = val === 4 ? Infinity : [1,3,7,30][val];
      document.getElementById('time-label').textContent = timeLabels[val];
      localStorage.setItem('timeFilterDays', timeFilterDays);
      applyFilters();
    });

    // === CHECKBOX CHANGE ===
    document.querySelectorAll('.type-checkbox').forEach(cb => {
      cb.addEventListener('change', function() {
        if (cb.checked) activeTypes.add(cb.value);
        else activeTypes.delete(cb.value);
        localStorage.setItem('alertTypeFilters', JSON.stringify([...activeTypes]));
        applyFilters();
      });
    });

    // === LOAD & DISPLAY MARKERS ===
    fetch(url)
      .then(response => {
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        return response.text();
      })
      .then(text => {
        let cleaned = text
          .replace(/^\/\*(.|\n)*?\*\//, '')
          .trim()
          .replace(/^google\.visualization\.Query\.setResponse\(/, '')
          .replace(/\);?$/, '');

        if (cleaned.startsWith('/') || cleaned.startsWith('<') || !cleaned.startsWith('{')) {
          throw new Error('Cleaned response not valid JSON');
        }

        const data = JSON.parse(cleaned);

        if (!data || !data.table) {
          throw new Error('No data.table in response');
        }

        const rows = data.table.rows || [];
        console.log(`Loaded ${rows.length} rows from Sheet`);

        allMarkers = [];

        rows.forEach(row => {
          const cells = row.c || [];

          const timestamp = cells[0]?.v || '';
          const reporter   = cells[1]?.v || 'Anonymous';
          const zone       = cells[3]?.v || 'Unknown';
          const spotDesc   = cells[4]?.v || '';
          const combinedCoords = cells[5]?.v || '';
          const alertTypeRaw = cells[6]?.v || 'Other';
          const alertType = alertTypeRaw.toLowerCase().trim();
          const details    = cells[7]?.v || '';
          const photo      = cells[8]?.v || '';

          let lat = null, lng = null;
          if (combinedCoords) {
            const cleanedCoords = combinedCoords.replace(/[^\d\.\-,\s]/g, '').trim();
            if (cleanedCoords.includes(',')) {
              const parts = cleanedCoords.split(',').slice(0, 2).map(s => parseFloat(s.trim()));
              if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
                lat = parts[0];
                lng = parts[1];
              }
            }
          }

          if (lat === null || lng === null) {
            const center = zoneCenters[zone] || [-30.85, 30.35];
            lat = center[0];
            lng = center[1];
          }

          let colorInfo = alertColors["default"];
          const descLower = details.toLowerCase();

          if (alertType.includes("general") || alertType.includes("suspicious")) {
            colorInfo = alertColors["general"];
          } else if (alertType.includes("red wave") || alertType.includes("flood")) {
            colorInfo = alertColors["red wave"];
          } else if (alertType.includes("amber blaze") || alertType.includes("fire") || alertType.includes("smoke")) {
            colorInfo = alertColors["amber blaze"];
          } else if (alertType.includes("scam")) {
            colorInfo = alertColors["scam"];
          } else if (alertType.includes("electrical")) {
            colorInfo = alertColors["electrical"];
          } else if (alertType.includes("water") || alertType.includes("leak")) {
            colorInfo = alertColors["water"];
          } else if (alertType.includes("dumping") || alertType.includes("rubbish") || alertType.includes("trash") || alertType.includes("garbage")) {
            colorInfo = alertColors["dumping"];
          } else if (alertType.includes("other municipal") || alertType.includes("potholes") || alertType.includes("lights") || alertType.includes("bushes")) {
            colorInfo = alertColors["other municipal"];
          } else if (alertType === "other" || alertType === "") {
            if (descLower.includes("bin") || descLower.includes("overflow") || descLower.includes("rubbish") || descLower.includes("trash") || descLower.includes("garbage") || descLower.includes("dump")) {
              colorInfo = alertColors["dumping"];
            }
          }

          const marker = L.circleMarker([lat, lng], {
            radius: 10,
            fillColor: colorInfo.fill,
            color: colorInfo.border,
            weight: 2,
            opacity: 1,
            fillOpacity: 0.85
          });

          marker.options.alertType = alertType || 'other';
          marker.options.timestamp = timestamp;

          marker.bindPopup(`
            <b>${alertTypeRaw} - ${zone}</b><br>
            ${spotDesc}<br>
            ${details.substring(0, 150)}${details.length > 150 ? '...' : ''}<br>
            Reported: ${timestamp}<br>
            By: ${reporter}<br>
            ${photo ? `<a href="${photo}" target="_blank">View Photo</a>` : ''}
          `);

          marker.addTo(map);
          allMarkers.push(marker);
        });

        applyFilters(); // Apply initial filters
      })
      .catch(err => {
        console.error('Error loading Sheet data:', err);
        document.body.innerHTML += 
          '<p style="color:red; text-align:center; padding:20px;">Error loading map: ' + err.message + '</p>';
      });

  // === MAP CLICK â†’ CONFIRMATION â†’ COPY COORDS + TEMPORARY MARKER ===
  map.on('click', function(e) {
    const lat = e.latlng.lat.toFixed(6);
    const lng = e.latlng.lng.toFixed(6);
    const coords = `${lat}, ${lng}`;

    const confirmContent = `
      <div style="text-align:center; padding:12px; min-width:260px;">
        <p style="margin:0 0 12px; font-weight:bold;">Report a new alert<br>at this location?</p>
        <button id="confirmYes" style="background:#4caf50; color:white; border:none; padding:10px 20px; margin:0 8px; border-radius:6px; cursor:pointer; font-size:1em;">
          Yes
        </button>
        <button id="confirmNo" style="background:#757575; color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; font-size:1em;">
          No
        </button>
      </div>
    `;

    const confirmPopup = L.popup()
      .setLatLng(e.latlng)
      .setContent(confirmContent)
      .openOn(map);

    setTimeout(() => {
      const yesBtn = document.getElementById('confirmYes');
      const noBtn  = document.getElementById('confirmNo');

      if (yesBtn) {
        yesBtn.onclick = () => {
          navigator.clipboard.writeText(coords)
            .then(() => console.log('Coords copied:', coords))
            .catch(err => console.error('Copy failed:', err));

          const tempMarker = L.circleMarker([lat, lng], {
            radius: 12,
            fillColor: '#ff1744',
            color: '#d50000',
            weight: 3,
            opacity: 1,
            fillOpacity: 0.7
          }).addTo(map);

          tempMarker.bindPopup(`
            <b>New alert location (temporary)</b><br>
            ${coords}<br>
            <small>Paste into form â€“ refresh map after submitting</small>
          `).openPopup();

          const toast = document.createElement('div');
          toast.innerHTML = 'Coordinates copied!<br>Paste into Latitude/Longitude field.';
          toast.style = 'position:fixed; bottom:30px; left:50%; transform:translateX(-50%); background:#323232ee; color:white; padding:12px 24px; border-radius:8px; z-index:2000; opacity:0; transition:opacity 0.4s; font-size:0.95em; text-align:center;';
          document.body.appendChild(toast);
          setTimeout(() => toast.style.opacity = '1', 100);
          setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 400);
          }, 3000);

          window.open("https://docs.google.com/forms/d/e/1FAIpQLSfRG4BSZMwlZtPakPJNaiDoR7XFpZUNDOyXRFOSY8lhfK_GtA/viewform", '_blank');

          map.closePopup(confirmPopup);
        };
      }

      if (noBtn) {
        noBtn.onclick = () => map.closePopup(confirmPopup);
      }
    }, 100);
  });
</script>
</body>
</html>
