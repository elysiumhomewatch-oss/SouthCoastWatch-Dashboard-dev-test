<!DOCTYPE html>
<html lang="en">
<head>
  <title>SouthCoastWatch Community Dashboard</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f8f9fa; }
    h1 { text-align: center; color: #1a3c6d; margin-bottom: 10px; }
    #map { height: 600px; margin: 20px auto; max-width: 1200px; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .leaflet-popup-content { margin: 0 !important; padding: 8px !important; min-width: 240px; }
  </style>
</head>
<body>
  <h1>ðŸŒŠ SouthCoastWatch Community Dashboard</h1>
 <div style="text-align:center; margin: 20px 0;">
  <button onclick="location.reload()" style="padding:12px 24px; font-size:1.1em; background:#1976d2; color:white; border:none; border-radius:8px; cursor:pointer;">
    Refresh Map (check for new alerts)
  </button>
</div>
  <!-- Map takes center stage â€“ no permanent form at top anymore -->
  <div id="map"></div>

  <script>
  // === Zone fallback centers ===
  const zoneCenters = {
    "Highway West": [-30.464248, 30.637618],
    "Sea East": [-30.90, 30.45],
    "River North": [-30.82, 30.38],
    "River South": [-30.88, 30.32],
    "Central": [-30.85, 30.35],
    "Unknown": [-30.85, 30.35]
  };

  // === Color definitions ===
  const alertColors = {
    "general": { fill: "#d32f2f", border: "#b71c1c" },
    "suspicious": { fill: "#d32f2f", border: "#b71c1c" },
    "red wave": { fill: "#1976d2", border: "#0d47a1" },
    "flood": { fill: "#1976d2", border: "#0d47a1" },
    "amber blaze": { fill: "#f57c00", border: "#ef6c00" },
    "fire": { fill: "#f57c00", border: "#ef6c00" },
    "smoke": { fill: "#f57c00", border: "#ef6c00" },
    "scam": { fill: "#7b1fa2", border: "#4a148c" },
    "electrical": { fill: "#fbc02d", border: "#f9a825" },
    "water": { fill: "#42a5f5", border: "#1976d2" },
    "leak": { fill: "#42a5f5", border: "#1976d2" },
    "dumping": { fill: "#795548", border: "#4e342e" },
    "other municipal": { fill: "#757575", border: "#424242" },
    "default": { fill: "#424242", border: "#212121" }
  };

  // === Initialize map ===
  const map = L.map('map').setView([-30.85, 30.35], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(map);

  // === Sheet ID ===
  const SHEET_ID = "1Bi9g1mnhkHFqqvNhIwQkikJ2gDkJx5xk5jheyu0kAE4";

  // === Feed URL ===
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=Form%20Responses%201`;

  // === Load existing alerts ===
  fetch(url)
    .then(response => {
      if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
      return response.text();
    })
    .then(text => {
      let cleaned = text
        .replace(/^\/\*(.|\n)*?\*\//, '')
        .trim()
        .replace(/^google\.visualization\.Query\.setResponse\(/, '')
        .replace(/\);?$/, '');

      if (cleaned.startsWith('/') || cleaned.startsWith('<') || !cleaned.startsWith('{')) {
        throw new Error('Cleaned response not valid JSON');
      }

      const data = JSON.parse(cleaned);

      if (!data || !data.table) {
        throw new Error('No data.table in response');
      }

      const rows = data.table.rows || [];
      console.log(`Loaded ${rows.length} rows from Sheet`);

      const markers = [];

      rows.forEach(row => {
        const cells = row.c || [];

        const timestamp = cells[0]?.v || '';
        const reporter   = cells[1]?.v || 'Anonymous';
        const zone       = cells[3]?.v || 'Unknown';
        const spotDesc   = cells[4]?.v || '';
        const combinedCoords = cells[5]?.v || '';
        const alertTypeRaw = cells[6]?.v || 'Other';
        const alertType = alertTypeRaw.toLowerCase().trim();
        const details    = cells[7]?.v || '';
        const photo      = cells[8]?.v || '';

        let lat = null, lng = null;
        if (combinedCoords) {
          const cleanedCoords = combinedCoords.replace(/[^\d\.\-,\s]/g, '').trim();
          if (cleanedCoords.includes(',')) {
            const parts = cleanedCoords.split(',').slice(0, 2).map(s => parseFloat(s.trim()));
            if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
              lat = parts[0];
              lng = parts[1];
            }
          }
        }

        if (lat === null || lng === null) {
          const center = zoneCenters[zone] || [-30.85, 30.35];
          lat = center[0];
          lng = center[1];
        }

        let colorInfo = alertColors["default"];
        const descLower = details.toLowerCase();

        if (alertType.includes("general") || alertType.includes("suspicious")) {
          colorInfo = alertColors["general"];
        } else if (alertType.includes("red wave") || alertType.includes("flood")) {
          colorInfo = alertColors["red wave"];
        } else if (alertType.includes("amber blaze") || alertType.includes("fire") || alertType.includes("smoke")) {
          colorInfo = alertColors["amber blaze"];
        } else if (alertType.includes("scam")) {
          colorInfo = alertColors["scam"];
        } else if (alertType.includes("electrical")) {
          colorInfo = alertColors["electrical"];
        } else if (alertType.includes("water") || alertType.includes("leak")) {
          colorInfo = alertColors["water"];
        } else if (alertType.includes("dumping") || alertType.includes("rubbish") || alertType.includes("trash") || alertType.includes("garbage")) {
          colorInfo = alertColors["dumping"];
        } else if (alertType.includes("other municipal") || alertType.includes("potholes") || alertType.includes("lights") || alertType.includes("bushes")) {
          colorInfo = alertColors["other municipal"];
        } else if (alertType === "other" || alertType === "") {
          if (descLower.includes("bin") || descLower.includes("overflow") || descLower.includes("rubbish") || descLower.includes("trash") || descLower.includes("garbage") || descLower.includes("dump")) {
            colorInfo = alertColors["dumping"];
          }
        }

        const marker = L.circleMarker([lat, lng], {
          radius: 10,
          fillColor: colorInfo.fill,
          color: colorInfo.border,
          weight: 2,
          opacity: 1,
          fillOpacity: 0.85
        }).addTo(map);

        marker.bindPopup(`
          <b>${alertTypeRaw} - ${zone}</b><br>
          ${spotDesc}<br>
          ${details.substring(0, 150)}${details.length > 150 ? '...' : ''}<br>
          Reported: ${timestamp}<br>
          By: ${reporter}<br>
          ${photo ? `<a href="${photo}" target="_blank">View Photo</a>` : ''}
        `);

        markers.push(marker);
      });

      if (markers.length > 0) {
        const group = L.featureGroup(markers);
        map.fitBounds(group.getBounds(), { padding: [50, 50] });
      }
    })
    .catch(err => {
      console.error('Error loading Sheet data:', err);
      document.body.innerHTML += 
        '<p style="color:red; text-align:center; padding:20px;">Error loading map: ' + err.message + '</p>';
    });

  // === MAP CLICK â†’ COPY COORDS TO CLIPBOARD ===
  map.on('click', function(e) {
    const lat = e.latlng.lat.toFixed(6);  // 6 decimals is usually enough
    const lng = e.latlng.lng.toFixed(6);
    const coords = `${lat}, ${lng}`;

    // Create popup with copy button
    const popupContent = `
      <div style="text-align:center; padding:12px; min-width:260px;">
        <p style="margin:0 0 12px; font-weight:bold;">Report a new alert here?</p>
        <p style="margin:0 0 10px; font-size:0.95em;">
          Coordinates copied to clipboard:<br>
          <strong>${coords}</strong>
        </p>
        <button id="copyConfirmBtn" style="background:#4caf50; color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; font-size:1em; margin:0 8px;">
          OK â€“ paste into form
        </button>
        <button id="cancelBtn" style="background:#757575; color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; font-size:1em;">
          Cancel
        </button>
      </div>
    `;

    const popup = L.popup()
      .setLatLng(e.latlng)
      .setContent(popupContent)
      .openOn(map);

    // Copy to clipboard and handle buttons
    navigator.clipboard.writeText(coords).then(() => {
      console.log('Coords copied:', coords);
    }).catch(err => {
      console.error('Clipboard copy failed:', err);
    });

    setTimeout(() => {
      const okBtn = document.getElementById('copyConfirmBtn');
      const cancelBtn = document.getElementById('cancelBtn');

      if (okBtn) {
        okBtn.onclick = () => {
          // Optional: open the form in new tab
          window.open(FORM_BASE_URL, '_blank');
          map.closePopup(popup);
        };
      }

      if (cancelBtn) {
        cancelBtn.onclick = () => map.closePopup(popup);
      }
    }, 100);
  });
</script>
</body>
</html>
