<!DOCTYPE html>
<html lang="en">
<head>
  <title>SouthCoastWatch Community Dashboard </title>
 
<hr style="margin: 30px 0;">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f8f9fa; }
    h1 { text-align: center; color: #333; }
    #map { height: 500px; margin-bottom: 20px; border: 1px solid #ccc; }
    #alerts { max-width: 800px; margin: 0 auto; }
    .alert-card { background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .alert-title { font-size: 1.2em; margin: 0 0 8px; color: #d32f2f; }
    .alert-meta { color: #666; font-size: 0.9em; margin-bottom: 8px; }
  </style>
</head>
<body>
  <h1>ðŸŒŠ SouthCoastWatch Community Dashboard</h1>
  <!-- Collapsible embedded form at top -->
  <details style="margin-bottom: 30px; max-width: 800px; margin-left: auto; margin-right: auto;">
    <summary style="font-size: 1.3em; cursor: pointer; background: #e3f2fd; padding: 12px; border-radius: 8px; font-weight: bold;">
      âž• Submit New Alert (click to open)
    </summary>
    <div style="padding: 20px; background: white; border: 1px solid #ddd; border-radius: 0 0 8px 8px;">
      <iframe src="https://docs.google.com/forms/d/e/1FAIpQLSfRG4BSZMwlZtPakPJNaiDoR7XFpZUNDOyXRFOSY8lhfK_GtA/viewform?embedded=true" 
        width="100%" height="800" frameborder="0" marginheight="0" marginwidth="0">
        Loadingâ€¦
      </iframe>
    </div>
  </details>

  <!-- Map container (now takes center stage) -->
  <div id="map" style="height: 600px; margin: 20px auto; max-width: 1000px; border: 1px solid #ccc;"></div>

  <!-- Your script block (updated to remove alert cards) -->
  <script>
// === Zone fallback centers ===
const zoneCenters = {
  "Highway West": [-30.464248, 30.637618],
  "Sea East": [-30.90, 30.45],
  "River North": [-30.82, 30.38],
  "River South": [-30.88, 30.32],
  "Central": [-30.85, 30.35],
  "Unknown": [-30.85, 30.35]
};

// === Color map â€“ exact or keyword matching ===
const alertColors = {
  "general": { fill: "#d32f2f", border: "#b71c1c" },           // Red
  "suspicious": { fill: "#d32f2f", border: "#b71c1c" },
  "red wave": { fill: "#1976d2", border: "#0d47a1" },          // Blue
  "flood": { fill: "#1976d2", border: "#0d47a1" },
  "amber blaze": { fill: "#f57c00", border: "#ef6c00" },       // Orange
  "fire": { fill: "#f57c00", border: "#ef6c00" },
  "smoke": { fill: "#f57c00", border: "#ef6c00" },
  "scam": { fill: "#7b1fa2", border: "#4a148c" },              // Purple
  "electrical": { fill: "#fbc02d", border: "#f9a825" },        // Yellow
  "water": { fill: "#42a5f5", border: "#1976d2" },             // Light Blue
  "leak": { fill: "#42a5f5", border: "#1976d2" },
  "dumping": { fill: "#795548", border: "#4e342e" },           // Brown
  "other municipal": { fill: "#757575", border: "#424242" },   // Gray
  "default": { fill: "#424242", border: "#212121" }            // Dark Gray fallback
};

// === Initialize map ===
const map = L.map('map').setView([-30.85, 30.35], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);

// === Sheet ID ===
const SHEET_ID = "1Bi9g1mnhkHFqqvNhIwQkikJ2gDkJx5xk5jheyu0kAE4";

// === Feed URL ===
const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=Form%20Responses%201`;

fetch(url)
  .then(response => {
    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
    return response.text();
  })
  .then(text => {
    let cleaned = text
      .replace(/^\/\*(.|\n)*?\*\//, '')
      .trim()
      .replace(/^google\.visualization\.Query\.setResponse\(/, '')
      .replace(/\);?$/, '');

    if (cleaned.startsWith('/') || cleaned.startsWith('<') || !cleaned.startsWith('{')) {
      throw new Error('Cleaned response not valid JSON');
    }

    const data = JSON.parse(cleaned);

    if (!data || !data.table) {
      throw new Error('No data.table in response');
    }

    const rows = data.table.rows || [];

    const markers = [];

    rows.forEach(row => {
      const cells = row.c || [];

      const timestamp = cells[0]?.v || '';
      const reporter   = cells[1]?.v || 'Anonymous';
      const zone       = cells[3]?.v || 'Unknown';
      const spotDesc   = cells[4]?.v || '';
      const combinedCoords = cells[5]?.v || '';
      const alertTypeRaw = cells[6]?.v || 'Other';
      const alertType = alertTypeRaw.toLowerCase().trim(); // Normalize for matching
      const details    = cells[7]?.v || '';
      const photo      = cells[8]?.v || '';

      let lat = null, lng = null;
      if (combinedCoords) {
        const cleanedCoords = combinedCoords.replace(/[^\d\.\-,\s]/g, '').trim();
        if (cleanedCoords.includes(',')) {
          const parts = cleanedCoords.split(',').slice(0, 2).map(s => parseFloat(s.trim()));
          if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
            lat = parts[0];
            lng = parts[1];
          }
        }
      }

      if (lat === null || lng === null) {
        const center = zoneCenters[zone] || [-30.85, 30.35];
        lat = center[0];
        lng = center[1];
      }

      // === Choose color by keyword match ===
      let colorInfo = alertColors["default"];
      if (alertType.includes("general") || alertType.includes("suspicious")) {
        colorInfo = alertColors["general"];
      } else if (alertType.includes("red wave") || alertType.includes("flood")) {
        colorInfo = alertColors["red wave"];
      } else if (alertType.includes("amber blaze") || alertType.includes("fire") || alertType.includes("smoke")) {
        colorInfo = alertColors["amber blaze"];
      } else if (alertType.includes("scam")) {
        colorInfo = alertColors["scam"];
      } else if (alertType.includes("electrical")) {
        colorInfo = alertColors["electrical"];
      } else if (alertType.includes("water") || alertType.includes("leak")) {
        colorInfo = alertColors["water"];
      } else if (alertType.includes("dumping")) {
        colorInfo = alertColors["dumping"];
      } else if (alertType.includes("other municipal") || alertType.includes("potholes") || alertType.includes("lights") || alertType.includes("bushes")) {
        colorInfo = alertColors["other municipal"];
      }

      console.log(`Alert type "${alertTypeRaw}" â†’ using color: ${colorInfo.fill}`);

      const marker = L.circleMarker([lat, lng], {
        radius: 10,
        fillColor: colorInfo.fill,
        color: colorInfo.border,
        weight: 2,
        opacity: 1,
        fillOpacity: 0.85
      }).addTo(map);

      marker.bindPopup(`
        <b>${alertTypeRaw} - ${zone}</b><br>
        ${spotDesc}<br>
        ${details.substring(0, 150)}${details.length > 150 ? '...' : ''}<br>
        Reported: ${timestamp}<br>
        By: ${reporter}<br>
        ${photo ? `<a href="${photo}" target="_blank">View Photo</a>` : ''}
      `);

      markers.push(marker);
    });

    if (markers.length > 0) {
      const group = L.featureGroup(markers);
      map.fitBounds(group.getBounds(), { padding: [50, 50] });
    }
  })
  .catch(err => {
    console.error('Error:', err);
    document.body.innerHTML += 
      '<p style="color:red; text-align:center; padding:20px;">Error loading map: ' + err.message + '</p>';
  });
</script>
</body>
</html>
