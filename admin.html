<!DOCTYPE html>
<html lang="en">
<head>
  <title>SouthCoastWatch Admin Dashboard</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- Leaflet core (same as public page) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f8f9fa; }
    h1 { text-align: center; color: #1a3c6d; margin-bottom: 10px; }
    #map { height: 500px; margin: 20px auto; max-width: 1200px; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    #alert-table { width: 100%; max-width: 1200px; margin: 20px auto; border-collapse: collapse; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    #alert-table th, #alert-table td { padding: 12px; border: 1px solid #ddd; text-align: left; }
    #alert-table th { background: #e3f2fd; font-weight: bold; }
    #alert-table tr:nth-child(even) { background: #f9f9f9; }
    .status-select { padding: 6px; border-radius: 4px; }
    .logout-btn { background: #d32f2f; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; float: right; }
    .logout-btn:hover { background: #b71c1c; }
    #loading { text-align: center; padding: 40px; font-size: 1.2em; color: #555; }
    #error { color: red; text-align: center; padding: 20px; }
    #admin-panel { max-width: 1200px; margin: 0 auto; }
  </style>
</head>
<body>

  <div id="admin-panel">
    <h1>SouthCoastWatch Admin Dashboard</h1>
    <button class="logout-btn" id="logout">Logout</button>

    <div id="map"></div>

    <table id="alert-table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Type</th>
          <th>Zone</th>
          <th>Reporter</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="alert-table-body"></tbody>
    </table>

    <div id="loading">Loading alerts...</div>
    <div id="error" style="display:none;"></div>
  </div>

  <script>
  // ────────────────────────────────────────────────
  // YOUR APPS SCRIPT URL (keep this exactly as is)
  // ────────────────────────────────────────────────
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyT27PxzMVY3KxMoiccBTipjQQ-44IYxQJqhuRB1v8tCXu7LUpMpcALeHltcl0RoZaW/exec";

  // Get stored admin credentials from localStorage
  const storedAuth = JSON.parse(localStorage.getItem('adminAuth') || 'null');

  // If no valid credentials → immediately redirect to login page
  if (!storedAuth || !storedAuth.email || !storedAuth.token) {
    alert("Please log in from the main dashboard first.");
    window.location.href = "/"; // change to full path if needed, e.g. "index.html"
  }

  // ────────────────────────────────────────────────
  // Verify admin credentials by calling the Apps Script
  // ────────────────────────────────────────────────
  async function verifyAdminAuth() {
    const params = new URLSearchParams({
      action: "check-auth",
      email: storedAuth.email.trim(),
      token: storedAuth.token.trim()
    });

    try {
      const response = await fetch(`${SCRIPT_URL}?${params.toString()}`);
      const data = await response.json();

      // Debug: show what the server actually returned
      console.log("Server auth response:", data);

      if (!data.success || !data.isAdmin) {
        alert("Session invalid or expired. Please log in again.");
        localStorage.removeItem('adminAuth');
        window.location.href = "/";
        return false;
      }

      return true;
    } catch (err) {
      console.error("Auth check failed:", err);
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').textContent = "Failed to verify admin access. Try again.";
      document.getElementById('error').style.display = 'block';
      return false;
    }
  }

  // ────────────────────────────────────────────────
  // Load alerts from the sheet (only runs after auth passes)
  // ────────────────────────────────────────────────
  async function loadAlerts() {
    document.getElementById('loading').textContent = "Verifying access...";

    const isAuthenticated = await verifyAdminAuth();
    if (!isAuthenticated) return;

    document.getElementById('loading').textContent = "Loading alerts...";

    try {
      const params = new URLSearchParams({
        action: "get-alerts",
        email: storedAuth.email.trim(),
        token: storedAuth.token.trim()
      });

      const response = await fetch(`${SCRIPT_URL}?${params.toString()}`);
      const data = await response.json();

      if (!data.success) {
        throw new Error(data.error || "Failed to load alerts");
      }

      const tbody = document.getElementById('alert-table-body');
      tbody.innerHTML = '';

      data.alerts.forEach(alert => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${alert.timestamp || '—'}</td>
          <td>${alert.type || 'Other'}</td>
          <td>${alert.zone || 'Unknown'}</td>
          <td>${alert.reporter || 'Anonymous'}</td>
          <td>
            <select class="status-select" data-row="${alert.row}">
              <option value="pending" ${alert.status === 'pending' ? 'selected' : ''}>Pending</option>
              <option value="in-progress" ${alert.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
              <option value="resolved" ${alert.status === 'resolved' ? 'selected' : ''}>Resolved</option>
            </select>
          </td>
          <td>
            <button class="view-btn" data-lat="${alert.lat || ''}" data-lng="${alert.lng || ''}">View on Map</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // Status change handler
      document.querySelectorAll('.status-select').forEach(select => {
        select.addEventListener('change', async function() {
          const row = this.dataset.row;
          const newStatus = this.value;

          if (!confirm(`Update status to "${newStatus}"?`)) {
            this.value = this.dataset.current || 'pending';
            return;
          }

          const params = new URLSearchParams({
            action: "update-status",
            row: row,
            status: newStatus,
            email: storedAuth.email.trim(),
            token: storedAuth.token.trim()
          });

          try {
            const resp = await fetch(`${SCRIPT_URL}?${params.toString()}`);
            const result = await resp.json();

            if (result.success) {
              alert("Status updated successfully.");
            } else {
              alert("Update failed: " + (result.error || "Unknown error"));
              this.value = this.dataset.current || 'pending';
            }
          } catch (err) {
            alert("Network error during update.");
            this.value = this.dataset.current || 'pending';
          }
        });
      });

      // View on map handler
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const lat = parseFloat(this.dataset.lat);
          const lng = parseFloat(this.dataset.lng);
          if (!isNaN(lat) && !isNaN(lng)) {
            map.setView([lat, lng], 15);
          } else {
            alert("No location data for this alert.");
          }
        });
      });

      document.getElementById('loading').style.display = 'none';

    } catch (err) {
      console.error("Error loading alerts:", err);
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').textContent = "Could not load alerts: " + err.message;
      document.getElementById('error').style.display = 'block';
    }
  }

  // Logout button
  document.getElementById('logout').addEventListener('click', () => {
    if (confirm("Are you sure you want to logout?")) {
      localStorage.removeItem('adminAuth');
      window.location.href = "/";
    }
  });

  // Initialize map
  const map = L.map('map').setView([-30.85, 30.35], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(map);

  // Start the process
  loadAlerts();
</script>
</body>
</html>
