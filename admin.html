<!DOCTYPE html>
<html lang="en">
<head>
  <title>SouthCoastWatch Admin Dashboard</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- Leaflet core (same as public page) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f8f9fa; }
    h1 { text-align: center; color: #1a3c6d; margin-bottom: 10px; }
    #map { height: 500px; margin: 20px auto; max-width: 1200px; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    #alert-table { width: 100%; max-width: 1200px; margin: 20px auto; border-collapse: collapse; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    #alert-table th, #alert-table td { padding: 12px; border: 1px solid #ddd; text-align: left; }
    #alert-table th { background: #e3f2fd; font-weight: bold; }
    #alert-table tr:nth-child(even) { background: #f9f9f9; }
    .status-select { padding: 6px; border-radius: 4px; }
    .logout-btn { background: #d32f2f; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; float: right; }
    .logout-btn:hover { background: #b71c1c; }
    #loading { text-align: center; padding: 40px; font-size: 1.2em; color: #555; }
    #error { color: red; text-align: center; padding: 20px; }
    #admin-panel { max-width: 1200px; margin: 0 auto; }
  </style>
</head>
<body>

  <div id="admin-panel">
    <h1>SouthCoastWatch Admin Dashboard</h1>
    <button class="logout-btn" id="logout">Logout</button>

    <div id="map"></div>

    <table id="alert-table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Type</th>
          <th>Zone</th>
          <th>Reporter</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="alert-table-body"></tbody>
    </table>

    <div id="loading">Loading alerts...</div>
    <div id="error" style="display:none;"></div>
  </div>

  <script>
    // CHANGE THIS TO YOUR REAL APPS SCRIPT WEB APP URL
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyT27PxzMVY3KxMoiccBTipjQQ-44IYxQJqhuRB1v8tCXu7LUpMpcALeHltcl0RoZaW/exec";

    // Get stored auth
    const storedAuth = JSON.parse(localStorage.getItem('adminAuth') || 'null');

    if (!storedAuth || !storedAuth.email || !storedAuth.token) {
      alert("Please log in first.");
      window.location.href = "/"; // redirect to public dashboard
    }

    // Verify auth with server
    async function verifyAdmin() {
      const params = new URLSearchParams({
        action: "check-auth",
        email: storedAuth.email,
        token: storedAuth.token
      });

      try {
        const response = await fetch(`${SCRIPT_URL}?${params}`);
        const data = await response.json();

        if (!data.success || !data.isAdmin) {
          alert("Invalid or expired session. Please log in again.");
          localStorage.removeItem('adminAuth');
          window.location.href = "/";
          return false;
        }

        document.getElementById('loading').style.display = 'none';
        return true;
      } catch (err) {
        console.error("Auth check failed", err);
        document.getElementById('error').textContent = "Authentication failed. Please try again.";
        document.getElementById('error').style.display = 'block';
        return false;
      }
    }

    // Load alerts (only if auth is valid)
    async function loadAlerts() {
      const isValid = await verifyAdmin();
      if (!isValid) return;

      try {
        const response = await fetch(`${SCRIPT_URL}?action=get-alerts`);
        const data = await response.json();

        if (!data.success) {
          document.getElementById('error').textContent = data.error || "Failed to load alerts";
          document.getElementById('error').style.display = 'block';
          return;
        }

        const tbody = document.getElementById('alert-table-body');
        tbody.innerHTML = '';

        data.alerts.forEach(alert => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${alert.timestamp || '—'}</td>
            <td>${alert.type}</td>
            <td>${alert.zone}</td>
            <td>${alert.reporter}</td>
            <td>
              <select class="status-select" data-id="${alert.row}">
                <option value="pending" ${alert.status === 'pending' ? 'selected' : ''}>Pending</option>
                <option value="in-progress" ${alert.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                <option value="resolved" ${alert.status === 'resolved' ? 'selected' : ''}>Resolved</option>
              </select>
            </td>
            <td><button class="view-btn" data-lat="${alert.lat}" data-lng="${alert.lng}">View on Map</button></td>
          `;
          tbody.appendChild(tr);
        });

        // Status change handler
        document.querySelectorAll('.status-select').forEach(select => {
          select.addEventListener('change', async function() {
            const row = this.dataset.id;
            const newStatus = this.value;

            if (confirm(`Change status to "${newStatus}"?`)) {
              const params = new URLSearchParams({
                action: "update-status",
                row: row,
                status: newStatus,
                email: storedAuth.email,
                token: storedAuth.token
              });

              const response = await fetch(`${SCRIPT_URL}?${params}`);
              const result = await response.json();

              if (result.success) {
                alert("Status updated!");
              } else {
                alert("Failed to update: " + (result.error || "Unknown error"));
                this.value = alert.status; // revert
              }
            }
          });
        });

        // View on map
        document.querySelectorAll('.view-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const lat = parseFloat(this.dataset.lat);
            const lng = parseFloat(this.dataset.lng);
            if (!isNaN(lat) && !isNaN(lng)) {
              map.setView([lat, lng], 16);
              // Optional: open popup or highlight marker
            }
          });
        });

      } catch (err) {
        console.error("Load alerts failed", err);
        document.getElementById('error').textContent = "Failed to load alerts";
        document.getElementById('error').style.display = 'block';
      }
    }

    // Logout
    document.getElementById('logout').addEventListener('click', () => {
      if (confirm("Logout from admin panel?")) {
        localStorage.removeItem('adminAuth');
        window.location.href = "/";
      }
    });

    // Initialize map (placeholder – can show alerts later)
    const map = L.map('map').setView([-30.85, 30.35], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    // Load data after auth check
    loadAlerts();
  </script>
</body>
</html>
